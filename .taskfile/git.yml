version: "3"

tasks:
  signing:
    desc: "配置 Git 提交签名"
    silent: true
    cmds:
      - |
        git config --global gpg.format ssh
        git config --global user.signingkey ~/.ssh/id_ed25519.pub
        git config --global commit.gpgsign true

  commit:
    desc: "使用 Claude AI 生成提交信息并提交代码"
    cmds:
      - |
        claude -p "use chinese exec git commit"

  push:
    desc: "推送代码"
    vars:
      TIME_NOW:
        sh: echo "chore $(TZ='Asia/Shanghai' date '+%Y-%m-%d %H:%M:%S %Z')"
    cmds:
      - |
        git add --all
        git status
        git diff --cached --quiet || git commit -m '{{.CLI_ARGS | default .TIME_NOW}}'
        git push

  tag:next:
    desc: "创建 tag (参数: [版本等级] [提交信息], 等级: 1=major, 2=minor, 3=patch, 默认 3)"
    vars:
      VERSION_LEVEL: '{{index (splitList " " .CLI_ARGS) 0 | default "3"}}'
      TAG_MESSAGE: '{{slice (splitList " " .CLI_ARGS) 1 | join " "}}'
      GIT_TAG_NEXT:
        sh: |
          level="{{.VERSION_LEVEL}}"
          tag="{{.GIT_TAG_LATEST}}"
          # 提取版本号部分 (去掉 v 前缀)
          version="${tag#v}"
          IFS='.' read -r major minor patch <<< "$version"
          case "$level" in
            1) echo "v$((major + 1)).0.0" ;;
            2) echo "v${major}.$((minor + 1)).0" ;;
            *) echo "v${major}.${minor}.$((patch + 1))" ;;
          esac
    cmds:
      - echo "{{.GIT_TAG_NEXT}}" | sed -r 's/^v//' | { read ver; sed -r 's|^(version =).*|\1 "'"$ver"'"|' pyproject.toml -i >/dev/null 2>&1; } || true
      - task: push
      - |
        git tag -a {{.GIT_TAG_NEXT}} -m '{{.TAG_MESSAGE | default "version bump"}}'
        git push origin {{.GIT_TAG_NEXT}}

  sync:upstream:
    desc: "从上游仓库同步代码到本地 main 分支并创建临时工作分支"
    silent: true
    cmds:
      - |
        # 检查是否配置了 upstream 远程仓库
        if ! git remote get-url upstream >/dev/null 2>&1; then
          echo "未配置 upstream 远程仓库，跳过同步"
          echo "提示: 使用 'git remote add upstream <url>' 添加上游仓库"
          exit 0
        fi

        # 保存当前分支名
        _current_branch=$(git branch --show-current)

        # 重置本地更改并清理未跟踪文件
        git reset --hard HEAD && git clean -fd

        # 切换到 main 分支
        git checkout main

        # 从 upstream 拉取并 rebase
        git pull --rebase upstream main

        # 推送到 origin main
        git push origin main

        echo "同步完成"
      - task: checkout:tmp

  checkout:tmp:
    desc: "创建临时工作分支"
    silent: true
    cmds:
      - |
        _ts=$(date "+%y%m%d-%H%M")
        # 切换到 main 分支
        git checkout main
        # 创建临时分支
        git checkout -b "tmp/${_ts}"
        echo "已创建临时分支: tmp/${_ts}"

  clear:
    desc: "清除历史提交记录 (危险)"
    silent: true
    cmds:
      - |
        _branch_name_current=$(git branch --show-current 2>/dev/null || echo "")
        _branch_name_backups="local/bak/${_branch_name_current}/$(date +'%Y/%m/%d/%H%M%S')"
        if [[ "${_branch_name_current}" == "" ]]; then
          echo "当前分支为空，跳过清除 git 缓存"
          exit 0
        fi
        git add -A && git commit -am "clear commit" --no-verify || true
        git rm -r --cached .
        git branch -m ${_branch_name_backups}
        git checkout --orphan ${_branch_name_current}
        git add -A && git commit -am "clear commit" --no-verify || true
        git push -f origin ${_branch_name_current}

  reinit:
    desc: "重新初始化 git (危险)"
    cmds:
      - |
        _remote_url=$(git remote get-url origin | head -n1)
        rm -rf .git
        git init --initial-branch=main
        touch README.md
        git add --all
        git commit -m "first commit" --no-verify || true
        git tag -a {{.GIT_TAG_LATEST}} -m "init"
        git remote add origin ${_remote_url}
        git config push.autoSetupRemote true
      - task: clear
